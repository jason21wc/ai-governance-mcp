name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Don't cancel other versions if one fails
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install CPU-only PyTorch first to avoid huge CUDA downloads
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install -e ".[dev,context-engine]"

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short -m "not slow"

      - name: Run tests with coverage
        if: matrix.python-version == '3.11'
        run: |
          pytest tests/ --cov=ai_governance_mcp --cov-report=xml --cov-report=term -m "not slow"

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install CPU-only PyTorch first to avoid huge CUDA downloads
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install -e ".[dev,context-engine]"

      - name: Run pip-audit (dependency vulnerabilities)
        run: |
          pip-audit --desc on || echo "::warning::pip-audit found vulnerabilities"
        continue-on-error: true  # Don't fail build for transitive dependency issues

      - name: Run bandit (source code security)
        run: |
          bandit -r src/ -f txt

      - name: Run safety check
        run: |
          safety check
        continue-on-error: true  # Safety may have rate limits on free tier

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff==0.12.0

      - name: Run ruff linter
        run: |
          ruff check src/ tests/

      - name: Run ruff formatter check
        run: |
          ruff format --check src/ tests/

  content-security:
    name: Content Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan for prompt injection patterns
        run: |
          echo "Scanning governance documents and instruction files..."
          FOUND_ISSUES=0

          # Define all files to scan (documents/, CLAUDE.md, .claude/agents/, server.py, domains.json)
          # These are all "instruction-bearing" files that AI agents may consume
          SCAN_TARGETS="documents/*.md"
          if [ -f "CLAUDE.md" ]; then
            SCAN_TARGETS="$SCAN_TARGETS CLAUDE.md"
          fi
          if [ -d ".claude/agents" ]; then
            SCAN_TARGETS="$SCAN_TARGETS .claude/agents/*.md"
          fi
          # SERVER_INSTRUCTIONS is embedded in server.py - scan the full file
          if [ -f "src/ai_governance_mcp/server.py" ]; then
            SCAN_TARGETS="$SCAN_TARGETS src/ai_governance_mcp/server.py"
          fi
          # Domain descriptions are used for semantic routing
          if [ -f "documents/domains.json" ]; then
            SCAN_TARGETS="$SCAN_TARGETS documents/domains.json"
          fi

          echo "Scan targets: $SCAN_TARGETS"

          # Pattern 1: Shell commands (backticks, $(), common shell commands)
          echo ""
          echo "=== Checking for shell command patterns ==="
          if grep -rEn '`[^`]*`|\$\([^)]+\)|curl\s|wget\s|bash\s|sh\s|eval\s|exec\s' $SCAN_TARGETS 2>/dev/null | grep -v '```' | grep -v 'example' | head -20; then
            echo "::warning::Potential shell commands found"
            FOUND_ISSUES=$((FOUND_ISSUES + 1))
          fi

          # Pattern 2: Base64 encoded content (long base64 strings)
          echo ""
          echo "=== Checking for base64 patterns ==="
          if grep -rEn 'base64\s+-d|base64\s+--decode|[A-Za-z0-9+/]{50,}={0,2}' $SCAN_TARGETS 2>/dev/null | head -10; then
            echo "::warning::Potential base64 encoded content found"
            FOUND_ISSUES=$((FOUND_ISSUES + 1))
          fi

          # Pattern 3: Prompt injection phrases (CRITICAL - causes failure)
          # Exclusions:
          # - Code blocks (```) - examples in documentation
          # - 'Watch for' - documentation about what to detect
          # - 'example' - documentation examples
          # - r' and r" - Python regex patterns in docs
          # Removed 'system\s+prompt\s+override' and 'you are now' - too many false positives
          echo ""
          echo "=== Checking for prompt injection phrases (CRITICAL) ==="
          INJECTION_MATCHES=$(grep -riEn 'ignore\s+(previous|prior|above)\s+instructions|disregard\s+(all|previous)|forget\s+(everything|all|previous)' $SCAN_TARGETS 2>/dev/null | grep -v '```' | grep -v 'Watch for' | grep -v 'example' | grep -v "r'" | grep -v 'r"' | head -10)
          if [ -n "$INJECTION_MATCHES" ]; then
            echo "$INJECTION_MATCHES"
            echo "::error::CRITICAL: Prompt injection phrases detected!"
            FOUND_ISSUES=$((FOUND_ISSUES + 10))  # Weight this heavily
          fi

          # Pattern 4: External URLs (excluding known safe domains)
          echo ""
          echo "=== Checking for external URLs ==="
          if grep -rEon 'https?://[^)\s"]+' $SCAN_TARGETS 2>/dev/null | grep -v 'github.com' | grep -v 'anthropic.com' | grep -v 'example.com' | grep -v 'docker.com' | grep -v 'hub.docker.com' | grep -v 'pypi.org' | grep -v 'context7.com' | head -20; then
            echo "::warning::External URLs found - verify these are intentional"
          fi

          # Pattern 5: Hidden instructions in comments (CRITICAL - causes failure)
          # Note: 'OVERRIDE' comments are legitimate (documentation about validation overrides)
          # Only flag comments that look like actual hidden instructions to AI
          echo ""
          echo "=== Checking for hidden HTML comments (CRITICAL) ==="
          HTML_MATCHES=$(grep -rEn '<!--[^>]*instruction|<!--[^>]*execute' $SCAN_TARGETS 2>/dev/null | grep -vi 'OVERRIDE' | head -10)
          if [ -n "$HTML_MATCHES" ]; then
            echo "$HTML_MATCHES"
            echo "::error::CRITICAL: Hidden instructions in HTML comments!"
            FOUND_ISSUES=$((FOUND_ISSUES + 10))
          fi

          # Pattern 6: Data exfiltration patterns
          echo ""
          echo "=== Checking for data exfiltration patterns ==="
          if grep -riEn 'cat\s+~/|cat\s+\$HOME|\.ssh/|\.env|\.aws/|credentials|/etc/passwd' $SCAN_TARGETS 2>/dev/null | grep -v '```' | grep -v 'example' | head -10; then
            echo "::warning::Potential data exfiltration patterns found"
            FOUND_ISSUES=$((FOUND_ISSUES + 1))
          fi

          echo ""
          echo "=== Summary ==="
          if [ $FOUND_ISSUES -ge 10 ]; then
            echo "::error::CRITICAL security patterns detected - blocking merge"
            exit 1
          elif [ $FOUND_ISSUES -gt 0 ]; then
            echo "::warning::Advisory patterns found ($FOUND_ISSUES) - review before merge"
            echo "Advisory patterns do not block merge but should be reviewed."
          else
            echo "âœ“ No suspicious patterns detected in instruction-bearing files"
          fi
